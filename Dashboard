import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import {
  BookOpen, Trophy, Zap, GraduationCap, TrendingUp, Target,
  Clock, Award, Brain, ChevronRight, Sparkles, Globe, Lock,
  Menu
} from "lucide-react";
import { motion } from "framer-motion";

export default function Dashboard() {
  const [language, setLanguage] = useState("sk");
  const [user, setUser] = useState(null);
  const [menuOpen, setMenuOpen] = useState(false);

  useEffect(() => {
    const loadUser = async () => {
      try {
        const currentUser = await base44.auth.me();
        setUser(currentUser);
      } catch (error) {
        console.error("Error loading user:", error);
      }
    };
    loadUser();
  }, []);

  const { data: subjects = [] } = useQuery({
    queryKey: ['subjects'],
    queryFn: () => base44.entities.Subject.list(),
    initialData: [],
  });

  const { data: allProgress = [] } = useQuery({
    queryKey: ['progress'],
    queryFn: () => base44.entities.UserProgress.list(),
    initialData: [],
  });

  const { data: allTopics = [] } = useQuery({
    queryKey: ['topics'],
    queryFn: () => base44.entities.Topic.list(),
    initialData: [],
  });

  const getSubjectProgress = (subjectId) => {
    const subjectTopics = allTopics.filter(t => t.subject_id === subjectId);
    if (subjectTopics.length === 0) return 0;
    
    const topicProgresses = subjectTopics.map(topic => {
      const progress = allProgress.find(p => p.topic_id === topic.id && p.created_by === user?.email);
      return progress?.score || 0;
    });
    
    return Math.round(topicProgresses.reduce((a, b) => a + b, 0) / subjectTopics.length);
  };

  const totalXP = allProgress
    .filter(p => p.created_by === user?.email)
    .reduce((sum, p) => sum + (p.total_xp || 0), 0);
  
  const currentStreak = Math.max(
    ...allProgress.filter(p => p.created_by === user?.email).map(p => p.streak_days || 0), 
    0
  );
  
  const completedTopics = allProgress
    .filter(p => p.created_by === user?.email && p.completed)
    .length;

  const t = {
    sk: {
      welcome: "Vitaj sp√§≈•",
      your_progress: "Tvoj pokrok dnes",
      total_xp: "Celkov√© XP",
      streak: "Denn√Ω streak",
      days: "dn√≠",
      completed: "Dokonƒçen√© t√©my",
      subjects: "Predmety",
      continue_learning: "Pokraƒçuj v uƒçen√≠",
      recommended: "Odpor√∫ƒçan√© pre teba",
      stats: "≈†tatistiky",
      achievements: "√öspechy",
      start_quiz: "Zaƒça≈• kv√≠z",
      view_subject: "Zobrazi≈• predmet",
      all_subjects: "V≈°etky predmety",
      free_plan: "Zadarmo pl√°n",
      upgrade: "Prejs≈• na Premium",
      topics: "t√©m",
    },
    en: {
      welcome: "Welcome back",
      your_progress: "Your progress today",
      total_xp: "Total XP",
      streak: "Daily streak",
      days: "days",
      completed: "Completed topics",
      subjects: "Subjects",
      continue_learning: "Continue learning",
      recommended: "Recommended for you",
      stats: "Statistics",
      achievements: "Achievements",
      start_quiz: "Start quiz",
      view_subject: "View subject",
      all_subjects: "All subjects",
      free_plan: "Free plan",
      upgrade: "Upgrade to Premium",
      topics: "topics",
    }
  };

  const text = t[language];

  const isPremium = user?.role === "admin";
  const visibleSubjects = isPremium ? subjects : subjects.filter(s => !s.premium_only).slice(0, 5);

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl border-b border-slate-200/50 sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setMenuOpen(!menuOpen)}
              className="rounded-xl"
            >
              <Menu className="w-6 h-6" />
            </Button>
            <Link to={createPageUrl("Home")} className="flex items-center gap-2">
              <div className="w-10 h-10 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-700 flex items-center justify-center">
                <GraduationCap className="w-6 h-6 text-white" />
              </div>
              <span className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                4ty
              </span>
            </Link>
          </div>
          
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setLanguage(language === "sk" ? "en" : "sk")}
              className="rounded-full"
            >
              <Globe className="w-4 h-4 mr-2" />
              {language.toUpperCase()}
            </Button>
            
            <motion.div 
              className="flex items-center gap-3 px-4 py-2 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500"
              whileHover={{ scale: 1.05 }}
            >
              <Zap className="w-5 h-5 text-white" />
              <span className="font-bold text-white">{totalXP} XP</span>
            </motion.div>
            
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center text-white font-bold">
              {user?.full_name?.[0] || "U"}
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 py-12">
        {/* Welcome Section */}
        <motion.div 
          className="mb-12"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <h1 className="text-4xl font-bold mb-2">
            {text.welcome}, {user?.full_name?.split(' ')[0] || "≈°tudent"}! üëã
          </h1>
          <p className="text-xl text-slate-600">{text.your_progress}</p>
        </motion.div>

        {/* Stats Cards */}
        <div className="grid md:grid-cols-3 gap-6 mb-12">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            whileHover={{ scale: 1.05, y: -5 }}
          >
            <Card className="p-6 rounded-3xl border-0 shadow-lg bg-gradient-to-br from-yellow-400 to-orange-500 text-white hover:shadow-2xl transition-all cursor-pointer">
              <div className="flex items-start justify-between mb-4">
                <div className="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-xl flex items-center justify-center">
                  <Zap className="w-6 h-6 text-white" />
                </div>
                <TrendingUp className="w-6 h-6 text-white/70" />
              </div>
              <div className="text-4xl font-bold mb-1">{totalXP}</div>
              <div className="text-white/90">{text.total_xp}</div>
            </Card>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            whileHover={{ scale: 1.05, y: -5 }}
          >
            <Card className="p-6 rounded-3xl border-0 shadow-lg bg-gradient-to-br from-pink-400 to-red-500 text-white hover:shadow-2xl transition-all cursor-pointer">
              <div className="flex items-start justify-between mb-4">
                <div className="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-xl flex items-center justify-center">
                  <Trophy className="w-6 h-6 text-white" />
                </div>
                <Award className="w-6 h-6 text-white/70" />
              </div>
              <div className="text-4xl font-bold mb-1">{currentStreak || 0}</div>
              <div className="text-white/90">{text.streak} {text.days}</div>
            </Card>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            whileHover={{ scale: 1.05, y: -5 }}
          >
            <Card className="p-6 rounded-3xl border-0 shadow-lg bg-gradient-to-br from-purple-400 to-blue-500 text-white hover:shadow-2xl transition-all cursor-pointer">
              <div className="flex items-start justify-between mb-4">
                <div className="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-xl flex items-center justify-center">
                  <Target className="w-6 h-6 text-white" />
                </div>
                <Brain className="w-6 h-6 text-white/70" />
              </div>
              <div className="text-4xl font-bold mb-1">{completedTopics}</div>
              <div className="text-white/90">{text.completed}</div>
            </Card>
          </motion.div>
        </div>

        {/* Upgrade Banner for Free Users */}
        {!isPremium && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="mb-8"
          >
            <Card className="p-8 rounded-3xl border-0 shadow-xl bg-gradient-to-r from-purple-600 to-blue-600 text-white relative overflow-hidden">
              <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32" />
              <div className="relative">
                <Badge className="mb-4 bg-yellow-400 text-yellow-900 border-0 rounded-full px-3">
                  {text.free_plan}
                </Badge>
                <h2 className="text-3xl font-bold mb-2">
                  {language === "sk" ? "Odomkni v≈°etky predmety" : "Unlock all subjects"}
                </h2>
                <p className="text-white/90 mb-6">
                  {language === "sk" 
                    ? "Z√≠skaj pr√≠stup k v≈°etk√Ωm t√©mam, neobmedzen√Ωm kv√≠zom a pokroƒçil√Ωm funkci√°m" 
                    : "Get access to all topics, unlimited quizzes and advanced features"}
                </p>
                <Link to={createPageUrl("Pricing")}>
                  <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                    <Button className="rounded-full bg-white text-purple-600 hover:bg-slate-100 h-12 px-8">
                      <Sparkles className="w-4 h-4 mr-2" />
                      {text.upgrade}
                    </Button>
                  </motion.div>
                </Link>
              </div>
            </Card>
          </motion.div>
        )}

        {/* Main Content */}
        <div className="grid lg:grid-cols-3 gap-8">
          {/* Subjects List */}
          <div className="lg:col-span-2">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-3xl font-bold">{text.subjects}</h2>
              <Link to={createPageUrl("Home")}>
                <Button variant="ghost" className="rounded-full">
                  {text.all_subjects}
                  <ChevronRight className="w-4 h-4 ml-1" />
                </Button>
              </Link>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {visibleSubjects.length === 0 ? (
                <Card className="col-span-2 p-12 rounded-3xl border-0 shadow-lg text-center">
                  <BookOpen className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-2xl font-bold mb-2">≈Ωiadne predmety</h3>
                  <p className="text-slate-600 mb-6">Zaƒçni pridan√≠m svojho prv√©ho predmetu</p>
                  <Link to={createPageUrl("Home")}>
                    <Button className="rounded-full bg-gradient-to-r from-purple-600 to-blue-600">
                      <Sparkles className="w-4 h-4 mr-2" />
                      Presk√∫ma≈• predmety
                    </Button>
                  </Link>
                </Card>
              ) : (
                visibleSubjects.map((subject, i) => {
                  const isLocked = subject.premium_only && !isPremium;
                  const subjectProgress = getSubjectProgress(subject.id);
                  
                  return (
                    <motion.div
                      key={subject.id}
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      transition={{ delay: i * 0.05 }}
                      whileHover={{ scale: isLocked ? 1 : 1.05, y: isLocked ? 0 : -5 }}
                    >
                      <Link to={isLocked ? createPageUrl("Pricing") : createPageUrl(`SubjectDetail?id=${subject.id}`)}>
                        <Card className="p-6 rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all group cursor-pointer relative">
                          {isLocked && (
                            <div className="absolute inset-0 bg-slate-900/10 rounded-3xl backdrop-blur-sm flex items-center justify-center z-10">
                              <div className="text-center">
                                <Lock className="w-8 h-8 mx-auto mb-2 text-slate-600" />
                                <Badge className="bg-yellow-100 text-yellow-800 border-0">Premium</Badge>
                              </div>
                            </div>
                          )}

                          <div className="flex items-start justify-between mb-4">
                            <div 
                              className="w-12 h-12 rounded-2xl flex items-center justify-center"
                              style={{ background: `linear-gradient(to bottom right, ${subject.color}, ${subject.color}dd)` }}
                            >
                              <BookOpen className="w-6 h-6 text-white" />
                            </div>
                            {subject.premium_only && (
                              <Badge className="bg-yellow-100 text-yellow-800 border-0 rounded-full">
                                Premium
                              </Badge>
                            )}
                          </div>
                          
                          <h3 className="text-xl font-bold mb-2">
                            {language === "sk" ? subject.name_sk : subject.name_en}
                          </h3>
                          
                          <p className="text-sm text-slate-600 mb-4">
                            {subject.topics_count} {text.topics}
                          </p>
                          
                          {!isLocked && (
                            <>
                              <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                  <span className="text-slate-600">Pokrok</span>
                                  <span className="font-semibold">{subjectProgress}%</span>
                                </div>
                                <Progress value={subjectProgress} className="h-2" />
                              </div>
                              
                              <Button className="w-full mt-4 rounded-full group-hover:bg-slate-900 transition-colors">
                                {text.view_subject}
                                <ChevronRight className="w-4 h-4 ml-2" />
                              </Button>
                            </>
                          )}
                        </Card>
                      </Link>
                    </motion.div>
                  );
                })
              )}
            </div>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Recommended Section */}
            <Card className="p-6 rounded-3xl border-0 shadow-lg bg-gradient-to-br from-slate-50 to-white">
              <div className="flex items-center gap-2 mb-4">
                <Sparkles className="w-5 h-5 text-purple-600" />
                <h3 className="text-xl font-bold">{text.recommended}</h3>
              </div>
              
              <div className="space-y-3">
                {allProgress
                  .filter(p => p.created_by === user?.email && p.score < 80)
                  .slice(0, 3)
                  .map((prog, i) => {
                    const topic = allTopics.find(t => t.id === prog.topic_id);
                    const subject = subjects.find(s => s.id === prog.subject_id);
                    
                    if (!topic || !subject) return null;
                    
                    return (
                      <Link key={i} to={createPageUrl(`TopicSelect?topicId=${topic.id}`)}>
                        <motion.div 
                          whileHover={{ scale: 1.02 }}
                          className="p-4 rounded-2xl bg-white border border-slate-200 hover:border-purple-300 transition-all cursor-pointer"
                        >
                          <div className="font-semibold text-sm mb-1">
                            {language === "sk" ? subject.name_sk : subject.name_en}
                          </div>
                          <div className="text-xs text-slate-600 mb-2">
                            {language === "sk" ? topic.name_sk : topic.name_en}
                          </div>
                          <Progress value={prog.score} className="h-1.5" />
                        </motion.div>
                      </Link>
                    );
                  })}
              </div>
            </Card>

            {/* Achievements */}
            <Card className="p-6 rounded-3xl border-0 shadow-lg">
              <div className="flex items-center gap-2 mb-4">
                <Award className="w-5 h-5 text-blue-600" />
                <h3 className="text-xl font-bold">{text.achievements}</h3>
              </div>
              
              <div className="grid grid-cols-3 gap-3">
                {[
                  { icon: Trophy, color: "from-yellow-400 to-orange-500" },
                  { icon: GraduationCap, color: "from-purple-400 to-blue-500" },
                  { icon: Zap, color: "from-pink-400 to-red-500" },
                  { icon: Target, color: "from-green-400 to-emerald-500" },
                  { icon: Brain, color: "from-purple-400 to-pink-500" },
                  { icon: Award, color: "from-cyan-400 to-blue-500" },
                ].map((achievement, i) => (
                  <motion.div 
                    key={i}
                    whileHover={{ scale: 1.1, rotate: 5 }}
                    className={`aspect-square rounded-2xl bg-gradient-to-br ${achievement.color} flex items-center justify-center cursor-pointer`}
                  >
                    <achievement.icon className="w-8 h-8 text-white" />
                  </motion.div>
                ))}
              </div>
            </Card>

            {/* Daily Goal */}
            <Card className="p-6 rounded-3xl border-0 shadow-lg bg-gradient-to-br from-purple-600 to-blue-600 text-white">
              <div className="flex items-center gap-2 mb-4">
                <Clock className="w-5 h-5" />
                <h3 className="text-xl font-bold">Denn√Ω cieƒæ</h3>
              </div>
              
              <div className="text-4xl font-bold mb-2">15/30</div>
              <p className="text-white/80 text-sm mb-4">min√∫t dnes</p>
              
              <Progress value={50} className="h-2 bg-white/20" />
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
